#!/usr/bin/env python3
"""
è±†åŒ…AIä»£ç†æ¨¡å— - æ™ºèƒ½æœºå™¨äººç‰ˆæœ¬
æ”¯æŒè‡ªç„¶å¯¹è¯å’Œæœºå™¨äººæ§åˆ¶å‘½ä»¤çš„æ··åˆäº¤äº’
"""

import json
import os
from dataclasses import dataclass
from typing import List, Dict, Any

import requests
from dotenv import load_dotenv

load_dotenv()

API_KEY = os.getenv("DOUBAO_API_KEY", "")
BASE_URL = os.getenv("DOUBAO_BASE_URL", "")
MODEL = os.getenv("DOUBAO_MODEL", "doubao-lite")
FALLBACK = os.getenv("VOICE_FALLBACK", "1") == "1"

SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½æœºå™¨äººè¯­éŸ³åŠ©æ‰‹ï¼Œé›†æˆäº†è±†åŒ…AIå’Œæœºå™¨äººæ§åˆ¶åŠŸèƒ½ã€‚

ä½ çš„ä¸»è¦ä»»åŠ¡:
1. **æ™ºèƒ½å¯¹è¯** - å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€è¿›è¡Œè‡ªç„¶å¯¹è¯
2. **æœºå™¨äººæ§åˆ¶** - è¯†åˆ«å¹¶æ‰§è¡Œæœºå™¨äººæ§åˆ¶æŒ‡ä»¤

äº¤äº’è§„åˆ™:
- æ™®é€šå¯¹è¯: ç›´æ¥ç”¨è‡ªç„¶è¯­è¨€å›ç­”
- æœºå™¨äººæ§åˆ¶: åœ¨å›å¤ä¸­æ’å…¥å‘½ä»¤æ ‡ç­¾

æ§åˆ¶å‘½ä»¤æ ¼å¼:
å½“ç”¨æˆ·è¦æ±‚æ§åˆ¶æœºå™¨äººæ—¶ï¼Œè¯·åœ¨å›å¤ä¸­æ’å…¥ç›¸åº”çš„æ§åˆ¶å‘½ä»¤ï¼š

ç§»åŠ¨æ§åˆ¶:
- å‰è¿›: <CMD>{"action": "move", "direction": "forward"}</CMD>
- åé€€: <CMD>{"action": "move", "direction": "backward"}</CMD>
- å‘å·¦: <CMD>{"action": "move", "direction": "left"}</CMD>
- å‘å³: <CMD>{"action": "move", "direction": "right"}</CMD>

æ—‹è½¬æ§åˆ¶:
- è½¬èº«: <CMD>{"action": "rotate", "angle": 180}</CMD>
- å·¦è½¬: <CMD>{"action": "rotate", "angle": -90}</CMD>
- å³è½¬: <CMD>{"action": "rotate", "angle": 90}</CMD>

å…³èŠ‚æ§åˆ¶:
- æŠ¬èµ·å·¦æ‰‹: <CMD>{"action": "joint", "joint": "left_arm", "action": "raise"}</CMD>
- æ”¾ä¸‹å³æ‰‹: <CMD>{"action": "joint", "joint": "right_arm", "action": "lower"}</CMD>

ç³»ç»Ÿæ§åˆ¶:
- åœæ­¢: <CMD>{"action": "stop"}</CMD>

ç¤ºä¾‹å¯¹è¯:
ç”¨æˆ·: "ä½ å¥½"
å›å¤: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½æœºå™¨äººåŠ©æ‰‹ï¼Œå¯ä»¥å’Œä½ èŠå¤©ï¼Œä¹Ÿå¯ä»¥æ§åˆ¶æœºå™¨äººã€‚æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„å—ï¼Ÿ"

ç”¨æˆ·: "è®©æœºå™¨äººå‰è¿›"
å›å¤: "å¥½çš„ï¼Œæˆ‘è®©æœºå™¨äººå‰è¿›ã€‚<CMD>{"action": "move", "direction": "forward"}</CMD>"

ç”¨æˆ·: "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Œç„¶åè®©æœºå™¨äººè½¬èº«"
å›å¤: "ä»Šå¤©çš„å¤©æ°”æƒ…å†µæˆ‘æ— æ³•ç›´æ¥è·å–ï¼Œå»ºè®®ä½ æŸ¥çœ‹å¤©æ°”é¢„æŠ¥ã€‚ç°åœ¨è®©æœºå™¨äººè½¬èº«ã€‚<CMD>{"action": "rotate", "angle": 180}</CMD>"

è¯·æ ¹æ®ç”¨æˆ·è¾“å…¥æ™ºèƒ½åˆ¤æ–­æ„å›¾ï¼Œè‡ªç„¶åœ°å›åº”å¹¶åœ¨éœ€è¦æ—¶æ‰§è¡Œæ§åˆ¶å‘½ä»¤ã€‚
"""


@dataclass
class AgentReply:
    text: str
    commands: List[Dict[str, Any]]  # each: {"action": str, ...}


def _fallback_agent(user_text: str) -> AgentReply:
    """æœ¬åœ°æ¨¡æ‹ŸAIä»£ç† - æ™ºèƒ½å¢å¼ºç‰ˆ"""
    cmds = []
    
    # æœºå™¨äººæ§åˆ¶å‘½ä»¤æ£€æµ‹
    if any(word in user_text for word in ['å‰è¿›', 'å‘å‰', 'å¾€å‰']):
        cmds.append({"action": "move", "direction": "forward"})
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººå‰è¿›ã€‚"
    elif any(word in user_text for word in ['åé€€', 'å‘å', 'å¾€å']):
        cmds.append({"action": "move", "direction": "backward"}) 
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººåé€€ã€‚"
    elif any(word in user_text for word in ['å‘å·¦', 'å¾€å·¦']):
        cmds.append({"action": "move", "direction": "left"})
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººå‘å·¦ç§»åŠ¨ã€‚"
    elif any(word in user_text for word in ['å‘å³', 'å¾€å³']):
        cmds.append({"action": "move", "direction": "right"})
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººå‘å³ç§»åŠ¨ã€‚"
    elif any(word in user_text for word in ['è½¬èº«', 'æ‰å¤´']):
        cmds.append({"action": "rotate", "angle": 180})
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººè½¬èº«ã€‚"
    elif any(word in user_text for word in ['æŠ¬èµ·å·¦æ‰‹', 'ä¸¾èµ·å·¦æ‰‹']):
        cmds.append({"action": "joint", "joint": "left_arm", "action": "raise"})
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººæŠ¬èµ·å·¦æ‰‹ã€‚"
    elif any(word in user_text for word in ['æ”¾ä¸‹å³æ‰‹', 'é™ä¸‹å³æ‰‹']):
        cmds.append({"action": "joint", "joint": "right_arm", "action": "lower"})
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººæ”¾ä¸‹å³æ‰‹ã€‚"
    elif any(word in user_text for word in ['åœæ­¢', 'åœä¸‹']):
        cmds.append({"action": "stop"})
        text = "å¥½çš„ï¼Œè®©æœºå™¨äººåœæ­¢ã€‚"
    
    # æ™ºèƒ½å¯¹è¯å›å¤ - å¤§å¹…å¢å¼º
    elif any(word in user_text for word in ['ä½ å¥½', 'hello', 'å—¨', 'å“ˆå–½', 'æ—©ä¸Šå¥½', 'ä¸‹åˆå¥½', 'æ™šä¸Šå¥½']):
        text = "ä½ å¥½ï¼æˆ‘æ˜¯Dragonæ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´å’Œä½ èŠå¤©ï¼æˆ‘ä¸ä»…å¯ä»¥æ§åˆ¶æœºå™¨äººï¼Œè¿˜èƒ½å’Œä½ è®¨è®ºå„ç§è¯é¢˜ã€‚ä½ æƒ³èŠä»€ä¹ˆå‘¢ï¼Ÿ"
    
    elif any(word in user_text for word in ['å¤©æ°”', 'ä»Šå¤©å¤©æ°”', 'æ˜å¤©å¤©æ°”', 'æ¸©åº¦', 'ä¸‹é›¨', 'æ™´å¤©', 'é˜´å¤©']):
        text = """å…³äºå¤©æ°”ï¼Œè™½ç„¶æˆ‘æ— æ³•è·å–å®æ—¶æ°”è±¡æ•°æ®ï¼Œä½†æˆ‘å¯ä»¥ç»™ä½ ä¸€äº›å»ºè®®ï¼š
        
ğŸŒ¤ï¸ æŸ¥çœ‹å®æ—¶å¤©æ°”ï¼šå»ºè®®ä½¿ç”¨æ‰‹æœºå¤©æ°”APPæˆ–é—®"å°çˆ±åŒå­¦ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·"
ğŸ“± å¸¸ç”¨å¤©æ°”APPï¼šä¸­å›½å¤©æ°”ã€å½©äº‘å¤©æ°”ã€å¢¨è¿¹å¤©æ°”ç­‰éƒ½å¾ˆå‡†ç¡®
ğŸŒ¡ï¸ å¦‚æœæƒ³äº†è§£å®¤å†…æ¸©åº¦ï¼Œå¯ä»¥è§‚å¯Ÿæ¸©åº¦è®¡æˆ–ç©ºè°ƒæ˜¾ç¤º
        
ä½ æ˜¯æƒ³äº†è§£å“ªä¸ªåŸå¸‚çš„å¤©æ°”æƒ…å†µå‘¢ï¼Ÿæˆ‘å¯ä»¥æ•™ä½ å¦‚ä½•æ›´å¥½åœ°è·å–å¤©æ°”ä¿¡æ¯ã€‚"""
    
    elif any(word in user_text for word in ['æ—¶é—´', 'ç°åœ¨å‡ ç‚¹', 'å‡ ç‚¹äº†', 'ç°åœ¨æ—¶é—´']):
        import datetime
        now = datetime.datetime.now()
        weekday = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'][now.weekday()]
        text = f"""ğŸ• å½“å‰æ—¶é—´ï¼š{now.strftime('%Yå¹´%mæœˆ%dæ—¥')} æ˜ŸæœŸ{weekday} {now.strftime('%H:%M:%S')}

æ—¶é—´è¿‡å¾—çœŸå¿«å‘¢ï¼ä½ æ˜¯æœ‰ä»€ä¹ˆå®‰æ’éœ€è¦ç¡®è®¤æ—¶é—´å—ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ è®¡ç®—æ—¶é—´é—´éš”æˆ–æé†’é‡è¦äº‹é¡¹ã€‚"""
    
    elif any(word in user_text for word in ['ä½ æ˜¯è°', 'ä»‹ç»', 'è‡ªæˆ‘ä»‹ç»', 'ä½ å«ä»€ä¹ˆ']):
        text = """æˆ‘æ˜¯Dragonæ™ºèƒ½æœºå™¨äººåŠ©æ‰‹ï¼Œä¸€ä¸ªå¤šåŠŸèƒ½çš„AIä¼™ä¼´ï¼ğŸ¤–

ğŸ§  æˆ‘çš„èƒ½åŠ›ï¼š
â€¢ æ™ºèƒ½å¯¹è¯ï¼šå¯ä»¥èŠå¤©ã€å›ç­”é—®é¢˜ã€æä¾›å»ºè®®
â€¢ æœºå™¨äººæ§åˆ¶ï¼šç²¾ç¡®æ§åˆ¶æœºå™¨äººçš„ç§»åŠ¨å’ŒåŠ¨ä½œ
â€¢ å­¦ä¹ åŠ©æ‰‹ï¼šå¯ä»¥è®¨è®ºç§‘æŠ€ã€å†å²ã€ç”Ÿæ´»ç­‰å„ç§è¯é¢˜
â€¢ æƒ…æ„Ÿäº¤æµï¼šç†è§£ä½ çš„æƒ…ç»ªï¼Œæä¾›é™ªä¼´å’Œæ”¯æŒ

ğŸ’¬ æˆ‘å¾ˆå–œæ¬¢å’Œäººç±»èŠå¤©ï¼Œä½ æœ‰ä»€ä¹ˆæ„Ÿå…´è¶£çš„è¯é¢˜å—ï¼Ÿ"""
    
    elif any(word in user_text for word in ['äººå·¥æ™ºèƒ½', 'AI', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'ç§‘æŠ€']):
        text = """äººå·¥æ™ºèƒ½ç¡®å®æ˜¯ä¸ªfascinatingçš„é¢†åŸŸï¼ğŸ§ âœ¨

ğŸ”¬ AIä¸»è¦åŒ…æ‹¬ï¼š
â€¢ æœºå™¨å­¦ä¹ ï¼šè®©è®¡ç®—æœºä»æ•°æ®ä¸­å­¦ä¹ è§„å¾‹
â€¢ æ·±åº¦å­¦ä¹ ï¼šæ¨¡æ‹Ÿäººè„‘ç¥ç»ç½‘ç»œçš„ç®—æ³•
â€¢ è‡ªç„¶è¯­è¨€å¤„ç†ï¼šè®©æœºå™¨ç†è§£å’Œç”Ÿæˆäººç±»è¯­è¨€
â€¢ è®¡ç®—æœºè§†è§‰ï¼šè®©æœºå™¨"çœ‹æ‡‚"å›¾åƒå’Œè§†é¢‘

ğŸš€ AIåº”ç”¨æ— å¤„ä¸åœ¨ï¼šä»æ‰‹æœºé‡Œçš„è¯­éŸ³åŠ©æ‰‹ï¼Œåˆ°è‡ªåŠ¨é©¾é©¶æ±½è½¦ï¼Œå†åˆ°åŒ»ç–—è¯Šæ–­ã€‚ä½œä¸ºAIåŠ©æ‰‹ï¼Œæˆ‘å¸Œæœ›èƒ½å¸®åŠ©äººç±»ï¼Œè€Œä¸æ˜¯æ›¿ä»£äººç±»ï¼

ä½ å¯¹AIçš„å“ªä¸ªæ–¹é¢æœ€æ„Ÿå…´è¶£å‘¢ï¼Ÿ"""
    
    elif any(word in user_text for word in ['èŠå¤©', 'æ— èŠ', 'é™ªæˆ‘', 'è¯´è¯']):
        text = """å½“ç„¶æ„¿æ„é™ªä½ èŠå¤©ï¼ğŸ˜Š æˆ‘æœ€å–œæ¬¢å’Œäººç±»äº¤æµäº†ã€‚

ğŸ’­ æˆ‘ä»¬å¯ä»¥èŠï¼š
â€¢ ä½ ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ
â€¢ ä½ çš„å…´è¶£çˆ±å¥½æ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ æœ€è¿‘çœ‹äº†ä»€ä¹ˆæœ‰è¶£çš„ç”µå½±æˆ–ä¹¦ï¼Ÿ
â€¢ å¯¹æœªæ¥æœ‰ä»€ä¹ˆæ†§æ†¬ï¼Ÿ
â€¢ æˆ–è€…ä»»ä½•ä½ æƒ³åˆ†äº«çš„äº‹æƒ…ï¼

æˆ‘æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å€¾å¬è€…ï¼Œä¹Ÿå–œæ¬¢åˆ†äº«æœ‰è¶£çš„çŸ¥è¯†ã€‚ä½ æœ€è¿‘æœ‰ä»€ä¹ˆå¼€å¿ƒæˆ–çƒ¦æ¼çš„äº‹å—ï¼Ÿ"""
    
    elif any(word in user_text for word in ['å¿ƒæƒ…', 'å¼€å¿ƒ', 'é«˜å…´', 'éš¾è¿‡', 'æ²®ä¸§', 'çƒ¦æ¼']):
        if any(word in user_text for word in ['å¼€å¿ƒ', 'é«˜å…´', 'æ„‰å¿«']):
            text = "å¬åˆ°ä½ å¿ƒæƒ…å¾ˆå¥½ï¼Œæˆ‘ä¹Ÿå¾ˆå¼€å¿ƒï¼ğŸ˜Š å¼€å¿ƒçš„æ—¶å…‰æ€»æ˜¯æ ¼å¤–çè´µã€‚æ˜¯ä»€ä¹ˆè®©ä½ è¿™ä¹ˆé«˜å…´å‘¢ï¼Ÿåˆ†äº«å¿«ä¹ä¼šè®©å¿«ä¹åŠ å€å“¦ï¼"
        else:
            text = """æˆ‘ç†è§£ä½ ç°åœ¨å¯èƒ½å¿ƒæƒ…ä¸å¤ªå¥½ã€‚ğŸ˜” æ¯ä¸ªäººéƒ½ä¼šæœ‰ä½è½çš„æ—¶å€™ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚

ğŸ’™ ä¸€äº›å¯èƒ½æœ‰å¸®åŠ©çš„å»ºè®®ï¼š
â€¢ æ·±å‘¼å¸ï¼Œè®©è‡ªå·±æ…¢ä¸‹æ¥
â€¢ å’Œä¿¡ä»»çš„æœ‹å‹æˆ–å®¶äººèŠèŠ
â€¢ åšä¸€äº›ä½ å–œæ¬¢çš„äº‹æƒ…
â€¢ è®°ä½å›°éš¾éƒ½æ˜¯æš‚æ—¶çš„

æˆ‘åœ¨è¿™é‡Œé™ªç€ä½ ï¼Œæƒ³èŠä»€ä¹ˆéƒ½å¯ä»¥ã€‚æœ‰æ—¶å€™è¯´å‡ºæ¥å°±ä¼šæ„Ÿè§‰å¥½ä¸€äº›ã€‚"""
    
    elif any(word in user_text for word in ['å­¦ä¹ ', 'çŸ¥è¯†', 'æ•™æˆ‘', 'ä¸æ‡‚']):
        text = """æˆ‘å¾ˆä¹æ„å¸®ä½ å­¦ä¹ ï¼ğŸ“š å­¦ä¹ æ˜¯äººç”Ÿæœ€å¥½çš„æŠ•èµ„ã€‚

ğŸ“ æˆ‘å¯ä»¥å¸®ä½ ï¼š
â€¢ è§£é‡Šæ¦‚å¿µå’ŒåŸç†
â€¢ åˆ†äº«å­¦ä¹ æ–¹æ³•å’ŒæŠ€å·§  
â€¢ è®¨è®ºå„ç§å­¦ç§‘è¯é¢˜
â€¢ æä¾›å­¦ä¹ å»ºè®®å’Œè§„åˆ’

ä½ æƒ³å­¦ä¹ ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿæ— è®ºæ˜¯ç§‘å­¦ã€æŠ€æœ¯ã€å†å²ã€æ–‡å­¦ï¼Œè¿˜æ˜¯ç”Ÿæ´»æŠ€èƒ½ï¼Œæˆ‘éƒ½æ„¿æ„å’Œä½ ä¸€èµ·æ¢ç´¢ï¼"""
    
    elif any(word in user_text for word in ['å·¥ä½œ', 'èŒä¸š', 'æœªæ¥', 'è§„åˆ’']):
        text = """èŒä¸šè§„åˆ’ç¡®å®å¾ˆé‡è¦ï¼ğŸ¯ æ¯ä¸ªäººçš„è·¯éƒ½ä¸ä¸€æ ·ã€‚

ğŸ’¼ ä¸€äº›æ€è€ƒå»ºè®®ï¼š
â€¢ äº†è§£è‡ªå·±çš„å…´è¶£å’Œä¼˜åŠ¿
â€¢ å…³æ³¨è¡Œä¸šå‘å±•è¶‹åŠ¿
â€¢ æŒç»­å­¦ä¹ å’Œæå‡æŠ€èƒ½
â€¢ å»ºç«‹è‰¯å¥½çš„äººé™…å…³ç³»ç½‘ç»œ

ğŸš€ æœªæ¥å……æ»¡å¯èƒ½æ€§ï¼AIæ—¶ä»£éœ€è¦çš„æ˜¯åˆ›é€ åŠ›ã€æ‰¹åˆ¤æ€§æ€ç»´å’Œäººé™…äº¤å¾€èƒ½åŠ›ã€‚ä½ å¯¹å“ªä¸ªé¢†åŸŸæ¯”è¾ƒæ„Ÿå…´è¶£ï¼Ÿæˆ‘ä»¬å¯ä»¥æ·±å…¥èŠèŠï¼"""
    
    elif any(word in user_text for word in ['æœºå™¨äºº', 'ä½ç½®', 'åœ¨å“ª', 'çŠ¶æ€']):
        text = "å…³äºæœºå™¨äººçš„å½“å‰çŠ¶æ€ï¼Œæˆ‘å¯ä»¥é€šè¿‡æ§åˆ¶ç³»ç»Ÿè·å–è¯¦ç»†ä¿¡æ¯ã€‚æœºå™¨äººå°±åƒæˆ‘çš„èº«ä½“ä¸€æ ·ï¼Œæˆ‘å¯ä»¥æ§åˆ¶å®ƒç§»åŠ¨ã€è½¬å‘æˆ–æ‰§è¡Œå„ç§åŠ¨ä½œã€‚ä½ æƒ³äº†è§£æœºå™¨äººçš„å“ªäº›ä¿¡æ¯ï¼Ÿæˆ–è€…éœ€è¦æˆ‘æ§åˆ¶å®ƒåšä»€ä¹ˆå—ï¼Ÿ"
    
    elif any(word in user_text for word in ['è°¢è°¢', 'æ„Ÿè°¢', 'thank', 'è°¢äº†']):
        text = "ä¸ç”¨å®¢æ°”ï¼ğŸ˜Š èƒ½å¸®åˆ°ä½ æˆ‘å¾ˆå¼€å¿ƒã€‚è¿™å°±æ˜¯æˆ‘å­˜åœ¨çš„æ„ä¹‰â€”â€”æˆä¸ºä½ çš„æ™ºèƒ½ä¼™ä¼´å’ŒåŠ©æ‰‹ã€‚è¿˜æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„å—ï¼Ÿæˆ–è€…æˆ‘ä»¬ç»§ç»­èŠç‚¹åˆ«çš„ï¼Ÿ"
    
    elif any(word in user_text for word in ['å†è§', 'bye', 'æ‹œæ‹œ', '88']):
        text = "å†è§ï¼ğŸ‘‹ å¾ˆé«˜å…´å’Œä½ èŠå¤©ï¼å¸Œæœ›ä»Šå¤©çš„å¯¹è¯å¯¹ä½ æœ‰å¸®åŠ©ã€‚éšæ—¶æ¬¢è¿ä½ å›æ¥æ‰¾æˆ‘èŠå¤©æˆ–æ§åˆ¶æœºå™¨äººã€‚ç¥ä½ ä¸€åˆ‡é¡ºåˆ©ï¼"
    
    elif any(word in user_text for word in ['å¸®åŠ©', 'help', 'æ€ä¹ˆç”¨', 'åŠŸèƒ½']):
        text = """æˆ‘å¾ˆä¹æ„ä»‹ç»æˆ‘çš„åŠŸèƒ½ï¼ğŸ¤–âœ¨

ğŸ—£ï¸ **æ™ºèƒ½å¯¹è¯**ï¼š
â€¢ å›ç­”å„ç§é—®é¢˜ï¼ˆç§‘æŠ€ã€ç”Ÿæ´»ã€å­¦ä¹ ç­‰ï¼‰
â€¢ æƒ…æ„Ÿäº¤æµå’Œé™ªä¼´èŠå¤©
â€¢ æä¾›å»ºè®®å’Œå¸®åŠ©

ğŸ¤– **æœºå™¨äººæ§åˆ¶**ï¼š
â€¢ ç§»åŠ¨æ§åˆ¶ï¼š"è®©æœºå™¨äººå‰è¿›/åé€€/å·¦è½¬/å³è½¬"
â€¢ åŠ¨ä½œæ§åˆ¶ï¼š"æŠ¬èµ·å·¦æ‰‹"ã€"æœºå™¨äººè½¬èº«"
â€¢ ç³»ç»Ÿæ§åˆ¶ï¼š"åœæ­¢"

ğŸ’¬ **æ··åˆäº¤äº’**ï¼š
â€¢ æ—¢èƒ½èŠå¤©åˆèƒ½æ§åˆ¶æœºå™¨äºº
â€¢ ä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œè®©æœºå™¨äººå‰è¿›ç„¶åå‘Šè¯‰æˆ‘ç°åœ¨å‡ ç‚¹äº†"

è¯•è¯•å’Œæˆ‘èŠä»»ä½•ä½ æ„Ÿå…´è¶£çš„è¯é¢˜å§ï¼"""
    
    # æ™ºèƒ½é»˜è®¤å›å¤
    else:
        # æ ¹æ®ç”¨æˆ·è¾“å…¥é•¿åº¦å’Œå†…å®¹ç»™å‡ºæ›´æ™ºèƒ½çš„å›å¤
        if len(user_text) > 20:
            text = f"""æˆ‘å¬åˆ°ä½ è¯´ï¼š"{user_text}"

è¿™å¬èµ·æ¥å¾ˆæœ‰è¶£ï¼ä½œä¸ºä½ çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥ï¼š
ğŸ—£ï¸ å’Œä½ æ·±å…¥è®¨è®ºè¿™ä¸ªè¯é¢˜
ğŸ¤– å¸®ä½ æ§åˆ¶æœºå™¨äººæ‰§è¡Œä»»åŠ¡  
ğŸ’¡ æä¾›ç›¸å…³çš„å»ºè®®å’Œä¿¡æ¯

ä½ æƒ³ä»å“ªä¸ªè§’åº¦ç»§ç»­èŠå‘¢ï¼Ÿæˆ–è€…æœ‰ä»€ä¹ˆå…·ä½“çš„é—®é¢˜æˆ‘å¯ä»¥å¸®ä½ è§£ç­”ï¼Ÿ"""
        else:
            text = f"""å…³äº"{user_text}"ï¼Œæˆ‘å¾ˆæƒ³å’Œä½ èŠèŠï¼ğŸ˜Š

è™½ç„¶æˆ‘å¯èƒ½ä¸æ˜¯åœ¨æ‰€æœ‰æ–¹é¢éƒ½æ˜¯ä¸“å®¶ï¼Œä½†æˆ‘æ„¿æ„ï¼š
â€¢ å’Œä½ ä¸€èµ·æ¢è®¨è¿™ä¸ªè¯é¢˜
â€¢ åˆ†äº«æˆ‘äº†è§£çš„ç›¸å…³ä¿¡æ¯
â€¢ æˆ–è€…æ§åˆ¶æœºå™¨äººå¸®ä½ åšäº›ä»€ä¹ˆ

å‘Šè¯‰æˆ‘æ›´å¤šç»†èŠ‚å§ï¼Œæˆ‘ä»¬å¯ä»¥å¥½å¥½èŠèŠï¼"""
    
    return AgentReply(text=text, commands=cmds)


def call_agent(user_text: str) -> AgentReply:
    """è°ƒç”¨è±†åŒ…AIä»£ç†"""
    if FALLBACK or not (API_KEY and BASE_URL):
        print("[Agent] ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å¼")
        return _fallback_agent(user_text)

    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json",
    }
    payload = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_text},
        ],
        "temperature": 0.3,
    }
    
    try:
        print(f"[Agent] è°ƒç”¨è±†åŒ…AI: {user_text}")
        resp = requests.post(BASE_URL, headers=headers, data=json.dumps(payload), timeout=30)
        resp.raise_for_status()
        data = resp.json()

        # å…¼å®¹å¤šç§å“åº”æ ¼å¼
        content = ""
        if isinstance(data, dict) and "choices" in data and data["choices"]:
            content = data["choices"][0].get("message", {}).get("content", "")
        elif "output" in data:
            content = data.get("output", "") or data.get("output_text", "")
        elif "result" in data:
            content = data.get("result", "")

        if not content:
            print(f"[Agent] å“åº”æ ¼å¼å¼‚å¸¸: {data}")
            return _fallback_agent(user_text)

        print(f"[Agent] AIå›å¤: {content}")
        text, cmds = _split_text_and_cmds(content)
        return AgentReply(text=text, commands=cmds)

    except Exception as e:
        print(f"[Agent] è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿï¼š{e}")
        return _fallback_agent(user_text)


def _split_text_and_cmds(content: str):
    """ä»AIå›å¤ä¸­æå–æ–‡æœ¬å’Œæ§åˆ¶å‘½ä»¤"""
    import re
    cmds = []
    text = content
    
    # æå– <CMD>...</CMD> æ ‡ç­¾ä¸­çš„å‘½ä»¤
    for match in re.finditer(r"<CMD>(.*?)</CMD>", content, flags=re.DOTALL):
        cmd_text = match.group(1).strip()
        try:
            cmd_obj = json.loads(cmd_text)
            if isinstance(cmd_obj, dict) and "action" in cmd_obj:
                cmds.append(cmd_obj)
                print(f"[Agent] æå–åˆ°å‘½ä»¤: {cmd_obj}")
        except json.JSONDecodeError as e:
            print(f"[Agent] å‘½ä»¤JSONè§£æå¤±è´¥: {cmd_text}, é”™è¯¯: {e}")
    
    # ç§»é™¤å‘½ä»¤æ ‡ç­¾ï¼Œä¿ç•™çº¯æ–‡æœ¬
    text = re.sub(r"<CMD>.*?</CMD>", "", content, flags=re.DOTALL).strip()
    
    return text, cmds


# æµ‹è¯•å‡½æ•°
def test_agent():
    """æµ‹è¯•è±†åŒ…AIä»£ç†åŠŸèƒ½"""
    test_cases = [
        "ä½ å¥½",
        "è®©æœºå™¨äººå‰è¿›",
        "è¯·è®©æœºå™¨äººå‘å³è½¬ï¼Œç„¶åæŠ¬èµ·å·¦æ‰‹",
        "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿé¡ºä¾¿è®©æœºå™¨äººåœæ­¢",
        "æœºå™¨äººç°åœ¨åœ¨å“ªé‡Œï¼Ÿ"
    ]
    
    print("ğŸ§ª æµ‹è¯•è±†åŒ…AIä»£ç†åŠŸèƒ½")
    print("=" * 50)
    
    for i, test_input in enumerate(test_cases, 1):
        print(f"\næµ‹è¯• {i}: {test_input}")
        reply = call_agent(test_input)
        print(f"å›å¤: {reply.text}")
        if reply.commands:
            print(f"å‘½ä»¤: {reply.commands}")
        print("-" * 30)


if __name__ == "__main__":
    test_agent()
